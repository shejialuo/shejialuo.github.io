<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Website mata -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Disable transformation -->
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<!-- Website description -->

<meta name="description" content="GSoC Week 1" />


<!-- Website keywords -->

<meta name="keywords" content="GSoC, 洛的藏书阁" />




<!-- Website rss -->

<link rel="alternate" href="/atom.xml" title="洛的藏书阁" type="application/atom+xml">


<!-- Website favicon -->

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=3.0.0" />


<!-- Canonical, good for google search engine -->
<link rel="canonical" href="https://luolibrary.com/2024/06/02/GSoC-Week-1/" />

<!-- Fancybox styling -->

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />


<!-- MathJax (LaTeX) support -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });  
  </script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<!-- Theme styling -->
<link rel="stylesheet" type="text/css" href="/css/style.css?v=3.0.0" />

<!-- Analytics and push -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7M238H24L4"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-7M238H24L4');
</script>

  



<!-- LeanCloud Counter -->


<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"latex":true};
</script>
  
  <title>GSoC Week 1 - 洛的藏书阁</title>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div class="scrollPercentage"></div>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">洛的藏书阁</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
    <a href="/">
      <li class="mobile-menu-item">
        
        
        Home              </li>
    </a>
    
    <a href="/archives/">
      <li class="mobile-menu-item">
        
        
        Archives              </li>
    </a>
    
    <a href="/tags/">
      <li class="mobile-menu-item">
        
        
        Tags              </li>
    </a>
    
    <a href="/categories/">
      <li class="mobile-menu-item">
        
        
        Categories              </li>
    </a>
    
    <a href="/about/">
      <li class="mobile-menu-item">
        
        
        About              </li>
    </a>
    
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
      <div class="logo-wrapper">  
  <a href="/." class="logo">洛的藏书阁</a>  
</div>  
  
<nav class="site-navbar">  
    
    <ul id="menu" class="menu">  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/">  
              
              
              Home  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/archives/">  
              
              
              Archives  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/tags/">  
              
              
              Tags  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/categories/">  
              
              
              Categories  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/about/">  
              
              
              About  
              
          </a>  
        </li>  
        
    </ul>  
    
</nav>  

    </header>
    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      GSoC Week 1
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-06-02
      </span>
      
      
      <span class="post-category">
        
        <a href="/categories/GSoC-2024/">GSoC 2024</a>
        
      </span>
      
      
    </div>
  </header>

  
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-I-Have-Done"><span class="toc-number">1.</span> <span class="toc-text">What I Have Done</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Set-Up-the-Infrastructure"><span class="toc-number">1.1.</span> <span class="toc-text">Set Up the Infrastructure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Name-and-Content-Check-For-Files-Backend"><span class="toc-number">1.2.</span> <span class="toc-text">Name and Content Check For Files Backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Limitations"><span class="toc-number">1.3.</span> <span class="toc-text">Limitations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Next-Plan"><span class="toc-number">2.</span> <span class="toc-text">Next Plan</span></a></li></ol>
    </div>
  </div>
  

  <div class="post-content">
    
    <h2 id="What-I-Have-Done"><a href="#What-I-Have-Done" class="headerlink" title="What I Have Done"></a>What I Have Done</h2><p>This is the first week of writing code. I spent most of my time building the infrastructure for the ref consistency check and implementing some consistency checks for the files backend.</p>
<h3 id="Set-Up-the-Infrastructure"><a href="#Set-Up-the-Infrastructure" class="headerlink" title="Set Up the Infrastructure"></a>Set Up the Infrastructure</h3><p>I reuse the polymorphism provided by <code>ref_storage_be</code> and add a new interface called <code>fsck_fn</code> to facilitate consistency checks for refs as the <a target="_blank" rel="noopener" href="https://lore.kernel.org/git/20240530122753.1114818-1-shejialuo@gmail.com/T/#m63c0d98020a814954f26c54c65bf04830bb0862a">refs: setup ref consistency check infrastructure</a> shows. Additionally, I implement dummy methods for different backends to ensure compatibility and extensibility.</p>
<h3 id="Name-and-Content-Check-For-Files-Backend"><a href="#Name-and-Content-Check-For-Files-Backend" class="headerlink" title="Name and Content Check For Files Backend"></a>Name and Content Check For Files Backend</h3><p>After setting up the infrastructure, I decide to add some basic checks for the file backend. We may need to parse every file located in a specific directory and perform checks on its content or file name. Therefore, I design the following workflow:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iter = dir_iterator_begin(dir, 0);</span><br><span class="line">while (dir_iterator_advance(iter) == ITER_OK)</span><br><span class="line">  if (IS_FILE(iter))</span><br><span class="line">    for (fn = fns; fn; fn++)</span><br><span class="line">      fn(iter)</span><br></pre></td></tr></table></figure>

<p>And I have written the following code to achieve above pseudo code.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*files_fsck_refs_fn)</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *refs_check_dir,</span></span><br><span class="line"><span class="params">        <span class="keyword">struct</span> dir_iterator *iter)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">files_fsck_refs</span><span class="params">(<span class="keyword">struct</span> ref_store *ref_store,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span>* refs_check_dir,</span></span><br><span class="line"><span class="params">        files_fsck_refs_fn *fsck_refs_fns)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">while</span> ((iter_status = dir_iterator_advance(iter)) == ITER_OK) &#123;</span><br><span class="line">    error(<span class="string">&quot;test: %s&quot;</span>, iter-&gt;relative_path);</span><br><span class="line">    <span class="keyword">if</span> (S_ISDIR(iter-&gt;st.st_mode)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (S_ISREG(iter-&gt;st.st_mode)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (files_fsck_refs_fn *fsck_refs_fn = fsck_refs_fns;</span><br><span class="line">          *fsck_refs_fn; fsck_refs_fn++) &#123;</span><br><span class="line">        ret |= (*fsck_refs_fn)(refs_check_dir, iter);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      error(_(<span class="string">&quot;unexpected file type for &#x27;%s&#x27;&quot;</span>), iter-&gt;basename);</span><br><span class="line">      ret = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For name check and content check, we should just following the prototype of <code>files_fsck_refs_fn</code>. Below shows the detail about these two functionalities.</p>
<ul>
<li>Name check: use the existing API <code>check_refname_format</code> to check the reference name.</li>
<li>Content check: check the following two cases.<ul>
<li>check whether the ref content length is valid and the last character is a newline.</li>
<li>check whether the content is be range of <code>[0-9a-f]</code>.</li>
</ul>
</li>
</ul>
<h3 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h3><p>There are many limitations for the current implementation:</p>
<ul>
<li>The semantic of <code>fsck_fn</code> should be presented either in code using comments or in commit message. As <a target="_blank" rel="noopener" href="https://github.com/gitster">Junio</a> said:<blockquote>
<p>What is the extra blank line doing there?  It makes reader wonder why the .fsck member is somehow very special and different from others.  Is there a valid reason to single it out (and no, “yes this is special because I invented it” does not count as a valid reason)? The same comment applies to a few other places in this patch.</p>
</blockquote>
</li>
<li>The current implementation totally ignores the symbolic ref such as <code>ref: refs/heads/main</code>.<blockquote>
<p>In any case, the two checks are good ONLY for regular refs and not for symbolic refs.  The users are free to create symbolic refs next to their branches, e.g. here is a way to say, “among the maintenance tracks maint-2.30, maint-2.31, … maint-2.44, maint-2.45, what I consider the primary maintenance track is currently maint-2.45”.</p>
</blockquote>
</li>
<li>The current implementation should consider the real symbolic file.<blockquote>
<p>The caller also needs to be prepared to find a real symbolic link that is used as a symbolic ref.</p>
</blockquote>
</li>
<li>The content check is not proper.<blockquote>
<p>I do not think it is a good idea to suddenly redefine what a valid way to write object names in a loose ref file after ~20 years. it should be at most FSCK_WARN when it does not look like what <em>we</em> wrote.</p>
</blockquote>
</li>
<li>The current implementation does not interact with the fsck error levels at all.<blockquote>
<p>How well does this interact with the fsck error levels (aka fsck_msg_type), by the way?  It should be made to work well if the current design does not.</p>
</blockquote>
</li>
</ul>
<h2 id="Next-Plan"><a href="#Next-Plan" class="headerlink" title="Next Plan"></a>Next Plan</h2><p>The next plan is very clear now.</p>
<ul>
<li>Really understand what <code>git-fsck</code> does to know whether we should port some functions to ref part and also to find a way to interact with teh fsck error levels.</li>
<li>Enhance the current implementation to support regular file containing symbolic ref and symbolic link file.</li>
<li>Understand how <code>git-worktree</code> works and incorporate the worktree like <code>git-fsck</code>.</li>
</ul>

    
  </div>

  
  <!-- Post Copyright -->

<div class="post-copyright">
  <p class="copyright-item">
    <span>Author: </span>
    <a href="https://luolibrary.com">shejialuo</a>
  </p>
  <p class="copyright-item">
    <span>Link: </span>
    <a href="https://luolibrary.com/2024/06/02/GSoC-Week-1/">https://luolibrary.com/2024/06/02/GSoC-Week-1/</a>
  </p>
  <p class="copyright-item">
    <span>License: </span>
    
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a>
  </p>
</div>

    

  

  
  <footer class="post-footer">
    
    <div class="post-tags">
      
      <a href="/tags/GSoC/">GSoC</a>
      
    </div>
    
      
  <nav class="post-nav">  
      
      <a class="prev" href="/2024/06/10/GSoC-Week-2/">  
        <i class="iconfont icon-left"></i>  
        <span class="prev-text nav-default">GSoC Week 2</span>  
        <span class="prev-text nav-mobile">Prev</span>  
      </a>  
      
      
      <a class="next" href="/2024/05/27/GSoC-Community-Bonding-Period/">  
        <span class="next-text nav-default">GSoC-Community Bonding Period</span>  
        <span class="prev-text nav-mobile">Next</span>  
        <i class="iconfont icon-right"></i>  
      </a>  
      
  </nav>  
  

  </footer>
  

</article>
        </div>
          
  <div class="comments" id="comments">  
      
      <div id="utterances-container"></div>  
      
  </div>  
  

      </div>
    </main>
    <footer id="footer" class="footer">
      <!-- Social Links -->

<div class="social-links">
  
  
  
  
  <a href="mailto:shejialuo@gmail.com" class="iconfont icon-email" title="email"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://twitter.com/luo_hope" class="iconfont icon-twitter" title="twitter"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://www.linkedin.com/in/jialuo-she-913873289/" class="iconfont icon-linkedin" title="linkedin"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://github.com/shejialuo" class="iconfont icon-github" title="github"></a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
  
</div>



<div class="copyright">

  <span class="copyright-year">
    <span>
      
      &copy;
      
      2020 - 2025      
    </span>

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>

    <span class="author">shejialuo</span>
  </span>

</div>
    </footer>
    <div class="back-to-top" id="back-to-top"> <i class="iconfont icon-up"></i> </div>
  </div>
    
    
    
    
    
  
<script>
  var container = document.getElementById('utterances-container');
  var script = document.createElement('script');
  script.src = 'https://utteranc.es/client.js';
  script.setAttribute('repo', 'shejialuo/shejialuo.github.io');
  script.setAttribute('issue-term', 'pathname');
  script.setAttribute('theme', 'github-light');
  script.setAttribute('label', 'Comment');
  script.crossorigin = 'anonymous';
  script.async = true;

  container.appendChild(script);
</script>
  
    
  

  







<script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>



<script type="text/javascript" src="/lib/slideout/slideout.js"></script>



<script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>



<!-- mermaid -->

  <script src='https://unpkg.com/mermaid@9.2.0/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


  <script type="text/javascript" src="/js/src/even.js?v=3.0.0"></script>
</body>

</html>