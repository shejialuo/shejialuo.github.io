<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Website mata -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Disable transformation -->
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<!-- Website description -->

<meta name="description" content="MIT6.824: MapReduce" />


<!-- Website keywords -->

<meta name="keywords" content="tag_name, 洛的藏书阁" />




<!-- Website rss -->

<link rel="alternate" href="/atom.xml" title="洛的藏书阁" type="application/atom+xml">


<!-- Website favicon -->

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=3.0.0" />


<!-- Canonical, good for google search engine -->
<link rel="canonical" href="https://luolibrary.com/2024/08/04/MIT6-824-MapReduce/" />

<!-- Fancybox styling -->

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />


<!-- MathJax (LaTeX) support -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });  
  </script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<!-- Theme styling -->
<link rel="stylesheet" type="text/css" href="/css/style.css?v=3.0.0" />

<!-- Analytics and push -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7M238H24L4"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-7M238H24L4');
</script>

  



<!-- LeanCloud Counter -->


<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"latex":true};
</script>
  
  <title>MIT6.824: MapReduce - 洛的藏书阁</title>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div class="scrollPercentage"></div>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">洛的藏书阁</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
    <a href="/">
      <li class="mobile-menu-item">
        
        
        Home              </li>
    </a>
    
    <a href="/archives/">
      <li class="mobile-menu-item">
        
        
        Archives              </li>
    </a>
    
    <a href="/tags/">
      <li class="mobile-menu-item">
        
        
        Tags              </li>
    </a>
    
    <a href="/categories/">
      <li class="mobile-menu-item">
        
        
        Categories              </li>
    </a>
    
    <a href="/about/">
      <li class="mobile-menu-item">
        
        
        About              </li>
    </a>
    
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
      <div class="logo-wrapper">  
  <a href="/." class="logo">洛的藏书阁</a>  
</div>  
  
<nav class="site-navbar">  
    
    <ul id="menu" class="menu">  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/">  
              
              
              Home  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/archives/">  
              
              
              Archives  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/tags/">  
              
              
              Tags  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/categories/">  
              
              
              Categories  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/about/">  
              
              
              About  
              
          </a>  
        </li>  
        
    </ul>  
    
</nav>  

    </header>
    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      MIT6.824: MapReduce
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2024-08-04
      </span>
      
      
      <span class="post-category">
        
        <a href="/categories/category-name/">category_name</a>
        
      </span>
      
      
    </div>
  </header>

  
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sequence-Version"><span class="toc-number">1.</span> <span class="toc-text">Sequence Version</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Need-Analysis"><span class="toc-number">2.</span> <span class="toc-text">Need Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Coordinator"><span class="toc-number">2.1.</span> <span class="toc-text">Coordinator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Worker"><span class="toc-number">2.2.</span> <span class="toc-text">Worker</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Data-Structure-Design"><span class="toc-number">3.</span> <span class="toc-text">Data Structure Design</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RPC-Operations"><span class="toc-number">4.</span> <span class="toc-text">RPC Operations</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Register"><span class="toc-number">4.1.</span> <span class="toc-text">Register</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request-Map-Task"><span class="toc-number">4.2.</span> <span class="toc-text">Request Map Task</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Finish-Map-Task"><span class="toc-number">4.3.</span> <span class="toc-text">Finish Map Task</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Coordinator-Operations"><span class="toc-number">5.</span> <span class="toc-text">Coordinator Operations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Worker-Operations"><span class="toc-number">6.</span> <span class="toc-text">Worker Operations</span></a></li></ol>
    </div>
  </div>
  

  <div class="post-content">
    
    <p>This is my record for finish MIT 6.824(spring 2022) first lab <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2022/labs/lab-mr.html">MapReduce</a>.</p>
<h2 id="Sequence-Version"><a href="#Sequence-Version" class="headerlink" title="Sequence Version"></a>Sequence Version</h2><p>Before we dive into how to solve this problem, we first need to understand the sequence version. First, we look at how <code>Map</code> operates.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">intermediate := []mr.KeyValue&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _ filename := <span class="keyword">range</span> os Args[<span class="number">2</span>:] &#123;</span><br><span class="line">  file, err := os.Open(filename)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, filename)</span><br><span class="line">  &#125;</span><br><span class="line">  content, err := io.ReadAll(file)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;cannot read %v&quot;</span>, filename)</span><br><span class="line">  &#125;</span><br><span class="line">  file.Close()</span><br><span class="line">  kva := mapf(filename, <span class="type">string</span>(content))</span><br><span class="line">  intermediate = <span class="built_in">append</span>(intermediate, kva...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The idea for above code is simple. It just calls the user-provided <code>Map</code> function to generate the key-value pair struct <code>mr.KeyValue</code> and put the results into <code>intermediate</code>.</p>
<p>Next we need to partitioning the <code>intermediate</code> to make it into groups. Actually, we can just sort the results. This is also what the code does.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort.Sort(ByKey(intermediate))</span><br></pre></td></tr></table></figure>

<p>Now next we need to call user-provided <code>Reduce</code> function. This is also easy. We have already sorted the <code>intermediate</code>. Now we just handle the groups one by one.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i &lt; <span class="built_in">len</span>(intermediate) &#123;</span><br><span class="line">  j := i + <span class="number">1</span></span><br><span class="line">  <span class="keyword">for</span> j &lt; <span class="built_in">len</span>(intermediate) &amp;&amp; intermediate[j].key == intermediate[i].key &#123;</span><br><span class="line">    j++</span><br><span class="line">  &#125;</span><br><span class="line">  values := []<span class="type">string</span>&#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> k := i; k &lt; j; k++ &#123;</span><br><span class="line">    values = <span class="built_in">append</span>(values, intermediate[k].Value)</span><br><span class="line">  &#125;</span><br><span class="line">  output := reducef(intermediate[i].Key, values)</span><br><span class="line">  fmt.Fprintf(ofile, <span class="string">&quot;%v %v\n&quot;</span>, intermediate[i].Key, output)</span><br><span class="line">  i = j</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Need-Analysis"><a href="#Need-Analysis" class="headerlink" title="Need Analysis"></a>Need Analysis</h2><h3 id="Coordinator"><a href="#Coordinator" class="headerlink" title="Coordinator"></a>Coordinator</h3><p>For MapReduce, there should be a coordinator which allocates the tasks. And the coordinator should use data structure to hold the status. The coordinator could not record the result file of the <code>Map</code> operation, because we have used some rules to make a pattern match.</p>
<h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><p>However, for a worker, things would be complicated. In the code, worker could do both <code>Map</code> and <code>Reduce</code>. I don’t think it is a good idea to make them exclusively. So for a worker, it should start two goroutines, one for <code>Map</code> and another for <code>Reduce</code>.</p>
<p>For <code>Map</code> operation, we should achieve the following functionality:</p>
<ul>
<li>Divide the intermediate keys into buckets for <code>nReduce</code> reduce tasks where <code>nReduce</code> is the number of reduce tasks.</li>
<li>The intermediate files name should be <code>mr-X-Y</code>, where <code>X</code> is the Map task number, and <code>Y</code> is the reduce task number.</li>
<li>Use <code>encoding/json</code> package to write the key&#x2F;value pairs in JSON format to intermediate files.</li>
</ul>
<p>For <code>Reduce</code> operation, we should achieve the following functionality:</p>
<ul>
<li>Use <code>encoding/json</code> package to read the key&#x2F;value paris in JSON format from intermediate files.</li>
<li>Put the output of the Xth reduce task in the file <code>mr-out-X</code>.</li>
</ul>
<h2 id="Data-Structure-Design"><a href="#Data-Structure-Design" class="headerlink" title="Data Structure Design"></a>Data Structure Design</h2><p>There are the following things we need to consider:</p>
<ul>
<li><p>We need to use the semantic words to represent the states both for the coordinator and workers. However, golang doesn’t provide <code>enum</code> type like C&#x2F;C++. So I decide to use <code>const</code> to emulate the <code>enum</code> type like the following:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WorkingStatus <span class="type">int32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  idle       WorkingStatus = <span class="number">0</span></span><br><span class="line">  processing WorkingStatus = <span class="number">1</span></span><br><span class="line">  failed     WorkingStatus = <span class="number">2</span></span><br><span class="line">  terminated WorkingStatus = <span class="number">3</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>We need to store the tasks we need to handle in the coordinator and also we need to allocate this task for worker. So we need a way to represent the <code>Map</code> and <code>Reduce</code> task.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTask <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID       <span class="type">int</span>    <span class="comment">// the current map task id</span></span><br><span class="line">  Filename <span class="type">string</span> <span class="comment">// the file which the map task is processing</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReduceTask <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID           <span class="type">int</span> <span class="comment">// the current reduce task id</span></span><br><span class="line">  MapTaskTotal <span class="type">int</span> <span class="comment">// the current total map task num for the reduce task</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>We need to store the worker information, because the worker may crash. If we do not store this state, we cannot do any crash recovery. Because a worker will handle <code>Map</code>and <code>Reduce</code> task, so we need to also create states to hold task status. I create a <code>WorkerState</code> to combine the <code>MapWorker</code> and <code>ReduceWorker</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MapWorker <span class="keyword">struct</span> &#123;</span><br><span class="line">status    WorkingStatus <span class="comment">// status</span></span><br><span class="line">task      MapTask       <span class="comment">// current task</span></span><br><span class="line">startTime time.Time     <span class="comment">// map task start time</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReduceWorker <span class="keyword">struct</span> &#123;</span><br><span class="line">  status    WorkingStatus <span class="comment">// status</span></span><br><span class="line">  task      ReduceTask    <span class="comment">// current task</span></span><br><span class="line">  startTime time.Time     <span class="comment">// reduce task start time</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WorkerState <span class="keyword">struct</span> &#123;</span><br><span class="line">  id           <span class="type">int</span>          <span class="comment">// Worker identifier</span></span><br><span class="line">  mapWorker    MapWorker    <span class="comment">// the map worker</span></span><br><span class="line">  reduceWorker ReduceWorker <span class="comment">// the reduce worker</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>And we could the following data structure for coordinator:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">  worker                []WorkerState <span class="comment">// To store the status of the workers</span></span><br><span class="line">  mapTask               []MapTask     <span class="comment">// The map tasks to be done</span></span><br><span class="line">  reduceTask            []ReduceTask  <span class="comment">// The reduce tasks to be done</span></span><br><span class="line">  mapTaskNum            <span class="type">int</span>           <span class="comment">// The total number of map task</span></span><br><span class="line">  reduceTaskNum         <span class="type">int</span>           <span class="comment">// The total number of reduce task</span></span><br><span class="line">  mapTaskFinishedNum    <span class="type">int</span>           <span class="comment">// The number of mapTask finished</span></span><br><span class="line">  reduceTaskFinishedNum <span class="type">int</span>           <span class="comment">// The number of reduceTask finished</span></span><br><span class="line">  allMapFinished        <span class="type">bool</span>          <span class="comment">// To indicate whether all Map operations are finished</span></span><br><span class="line">  allReduceFinished     <span class="type">bool</span>          <span class="comment">// To indicate whether all Reduce operations are finished</span></span><br><span class="line">  status                WorkingStatus <span class="comment">// The status of the coordinator</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RPC-Operations"><a href="#RPC-Operations" class="headerlink" title="RPC Operations"></a>RPC Operations</h2><p>Next, we need to handle the rpc operations where we need to consider the synchronization between workers and coordinator.</p>
<h3 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h3><p>When a worker is initialized, it should call <code>Register</code> RPC. The coordinator should lock the mutex and update the <code>worker</code> field and return the id and the reduce bucket to the worker like the following:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RegisterRequest <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RegisterResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID      <span class="type">int</span> <span class="comment">// the worker identifier</span></span><br><span class="line">  NReduce <span class="type">int</span> <span class="comment">// the reduce bucket</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Register(request *RegisterRequest, response *RegisterResponse) <span class="type">error</span> &#123;</span><br><span class="line">  mutex.Lock()</span><br><span class="line">  <span class="keyword">defer</span> mutex.Unlock()</span><br><span class="line"></span><br><span class="line">  newId := <span class="built_in">len</span>(c.worker)</span><br><span class="line"></span><br><span class="line">  newWorker := WorkerState&#123;</span><br><span class="line">    id: newId,</span><br><span class="line">    mapWorker: MapWorker&#123;</span><br><span class="line">      status: idle,</span><br><span class="line">    &#125;,</span><br><span class="line">    reduceWorker: ReduceWorker&#123;</span><br><span class="line">      status: idle,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  c.worker = <span class="built_in">append</span>(c.worker, newWorker)</span><br><span class="line"></span><br><span class="line">  response.ID = newId</span><br><span class="line">  response.NReduce = c.reduceTaskNum</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Request-Map-Task"><a href="#Request-Map-Task" class="headerlink" title="Request Map Task"></a>Request Map Task</h3><p>When the workers want to request map task, it should call <code>MapRequest</code> RPC. However, when there is no task available allocated to the worker, we should block the process in RPC call. You could see the following code to understand the detail.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID <span class="type">int</span> <span class="comment">// the worker identifier</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MapTaskResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">  Task     MapTask</span><br><span class="line">  Shutdown <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> MapRequest(</span><br><span class="line">  request *MapTaskRequest,</span><br><span class="line">  response *MapTaskResponse) <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">  condMap.L.Lock()</span><br><span class="line">  <span class="keyword">defer</span> condMap.L.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Here, we use `len(c.filenames)` to indicate whether there is</span></span><br><span class="line">  <span class="comment">// an available task for `Map` operation.</span></span><br><span class="line">  <span class="keyword">for</span> <span class="built_in">len</span>(c.mapTask) == <span class="number">0</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If all of the `Map` operation is finished, we should</span></span><br><span class="line">    <span class="comment">// set the `Shutdown` field to `true` and return.</span></span><br><span class="line">    <span class="keyword">if</span> c.allMapFinished &#123;</span><br><span class="line">      response.Shutdown = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    condMap.Wait()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We should return map task back to the `Map`</span></span><br><span class="line">  response.Task = c.mapTask[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Here, we should store the information of the worker</span></span><br><span class="line">  c.worker[request.ID].mapWorker.task = c.mapTask[<span class="number">0</span>]</span><br><span class="line">  c.worker[request.ID].mapWorker.status = processing</span><br><span class="line">  c.worker[request.ID].mapWorker.startTime = time.Now()</span><br><span class="line"></span><br><span class="line">  c.mapTask = c.mapTask[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Finish-Map-Task"><a href="#Finish-Map-Task" class="headerlink" title="Finish Map Task"></a>Finish Map Task</h3><p>When the workers finish the <code>Map</code> operation, it should call <code>MapFinish</code> to indicate the coordinator that “I have finished this task”. However, there are so many details we need to consider:</p>
<ol>
<li>There are some tasks running too much time which we will consider they are failed. If later the coordinator receives the <code>MapFinish</code> request, we should simply indicate the workers that they should be shutdown.</li>
<li>Because the workers may crash, we should never write the real name here. Instead workers should create temp file name. The coordinator should rename this in the RPC call. So we need to add a new field <code>Info</code> representing the mapping between the temp file name and the original file name.</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MapTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  Info <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> MapFinish(</span><br><span class="line">  request *MapTaskRequest,</span><br><span class="line">  response *MapTaskResponse) <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">  mutex.Lock()</span><br><span class="line">  <span class="keyword">defer</span> mutex.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> c.worker[request.ID].mapWorker.status == failed ||</span><br><span class="line">    c.allMapFinished &#123;</span><br><span class="line">    response.Shutdown = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> c.worker[request.ID].mapWorker.status == processing &amp;&amp; !c.allMapFinished &#123;</span><br><span class="line"></span><br><span class="line">    c.mapTaskFinishedNum++</span><br><span class="line"></span><br><span class="line">    c.worker[request.ID].mapWorker.status = idle</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> temp, original := <span class="keyword">range</span> request.Info &#123;</span><br><span class="line">      os.Rename(temp, original)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When all the `Map` operation is finished we should broadcast for</span></span><br><span class="line">    <span class="comment">// `Reduce` operation. Pay attention that `len(c.filenames) == 0`</span></span><br><span class="line">    <span class="keyword">if</span> c.mapTaskFinishedNum == c.mapTaskNum &#123;</span><br><span class="line">      c.allMapFinished = <span class="literal">true</span></span><br><span class="line">      condReduce.Broadcast()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The <code>ReduceRequest</code> and <code>ReduceFinish</code> functions are like <code>MapRequest</code> and <code>MapFinish</code>. I omit the detail here.</p>
<h2 id="Coordinator-Operations"><a href="#Coordinator-Operations" class="headerlink" title="Coordinator Operations"></a>Coordinator Operations</h2><p>There are two operations we need to consider for coordinator, one is that coordinator needs to check the liveness of the each worker for executing crash recovery. I define a goroutine <code>checkLiveness</code> here.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> checkLiveness() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line"></span><br><span class="line">    done := c.Done()</span><br><span class="line">    <span class="keyword">if</span> done &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex.Lock()</span><br><span class="line"></span><br><span class="line">    mapRestartTime := <span class="number">0</span></span><br><span class="line">    reduceRestartTime := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> c.worker &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> c.worker[i].mapWorker.status == processing &amp;&amp; time.Since(c.worker[i].mapWorker.startTime).Seconds() &gt; <span class="number">10</span> &#123;</span><br><span class="line">        c.mapTask = <span class="built_in">append</span>(c.mapTask, MapTask&#123;</span><br><span class="line">          ID:       c.worker[i].mapWorker.task.ID,</span><br><span class="line">          Filename: c.worker[i].mapWorker.task.Filename,</span><br><span class="line">        &#125;)</span><br><span class="line">        c.worker[i].mapWorker.status = failed</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> c.worker[i].reduceWorker.status == processing &amp;&amp; time.Since(c.worker[i].reduceWorker.startTime).Seconds() &gt; <span class="number">10</span> &#123;</span><br><span class="line">        reduceRestartTime++</span><br><span class="line">        c.reduceTask = <span class="built_in">append</span>(c.reduceTask, ReduceTask&#123;</span><br><span class="line">          MapTaskTotal: c.worker[i].reduceWorker.task.MapTaskTotal,</span><br><span class="line">          ID:           c.worker[i].reduceWorker.task.ID,</span><br><span class="line">        &#125;)</span><br><span class="line">        c.worker[i].reduceWorker.status = failed</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; mapRestartTime; i++ &#123;</span><br><span class="line">      condMap.Signal()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; reduceRestartTime; i++ &#123;</span><br><span class="line">      condReduce.Signal()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex.Unlock()</span><br><span class="line"></span><br><span class="line">    time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Worker-Operations"><a href="#Worker-Operations" class="headerlink" title="Worker Operations"></a>Worker Operations</h2><p>The entrypoint is the <code>Worker</code> function, we will start two goroutine in this function, one is used for handling <code>mapProcess</code> and the other is used for handling <code>reduceProcess</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(mapf <span class="keyword">func</span>(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue,</span><br><span class="line">  reducef <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When there is a new worker, we should call RPC</span></span><br><span class="line">  <span class="comment">// `RegisterRPC`.</span></span><br><span class="line">  response := RegisterResponse&#123;&#125;</span><br><span class="line">  request := RegisterRequest&#123;&#125;</span><br><span class="line">  mutex = sync.Mutex&#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> !RegisterRPC(&amp;request, &amp;response) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  wg.Add(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> mapProcess(mapf, response.ID, response.NReduce)</span><br><span class="line">  <span class="keyword">go</span> reduceProcess(reducef, response.ID, response.NReduce)</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mapProcess</code> goroutine will handle the following things:</p>
<ol>
<li>Firstly uses <code>MapRequestRPC</code> to request one job from coordinator, and the most two important things got from coordinator is the <code>MapTask</code> structure.</li>
<li>We need to maintain the mapping between the temp file name and the original filename.</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapProcess</span><span class="params">(mapf <span class="keyword">func</span>(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue, id <span class="type">int</span>, nReduce <span class="type">int</span>) &#123;</span><br><span class="line">  <span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line"></span><br><span class="line">    request := MapTaskRequest&#123;ID: id&#125;</span><br><span class="line">    response := MapTaskResponse&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !MapRequestRPC(&amp;request, &amp;response) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the coordinator is terminated, we should terminate</span></span><br><span class="line">    <span class="comment">// the `mapProcess`</span></span><br><span class="line">    <span class="keyword">if</span> response.Shutdown &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tempToOriginal := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">    intermediate := []KeyValue&#123;&#125;</span><br><span class="line">    filename := response.Task.Filename</span><br><span class="line">    file, _ := os.Open(filename)</span><br><span class="line">    content, _ := io.ReadAll(file)</span><br><span class="line">    file.Close()</span><br><span class="line">    kva := mapf(filename, <span class="type">string</span>(content))</span><br><span class="line">    intermediate = <span class="built_in">append</span>(intermediate, kva...)</span><br><span class="line"></span><br><span class="line">    outputNamePrefix := fmt.Sprintf(<span class="string">&quot;mr-%d-&quot;</span>, response.Task.ID)</span><br><span class="line"></span><br><span class="line">    outputFile := []*os.File&#123;&#125;</span><br><span class="line">    enc := []*json.Encoder&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= nReduce; i++ &#123;</span><br><span class="line">      outputName := fmt.Sprintf(<span class="string">&quot;%s%d&quot;</span>, outputNamePrefix, i)</span><br><span class="line">      tempFile, _ := os.CreateTemp(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;tempfile-&quot;</span>)</span><br><span class="line">      tempToOriginal[tempFile.Name()] = outputName</span><br><span class="line"></span><br><span class="line">      encTemp := json.NewEncoder(tempFile)</span><br><span class="line">      outputFile = <span class="built_in">append</span>(outputFile, tempFile)</span><br><span class="line">      enc = <span class="built_in">append</span>(enc, encTemp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, kv := <span class="keyword">range</span> intermediate &#123;</span><br><span class="line">      reduceNum := ihash(kv.Key) % nReduce</span><br><span class="line">      enc[reduceNum].Encode(kv)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, file := <span class="keyword">range</span> outputFile &#123;</span><br><span class="line">      file.Close()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    request.Info = tempToOriginal</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !MapFinishRPC(&amp;request, &amp;response) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k := <span class="keyword">range</span> tempToOriginal &#123;</span><br><span class="line">      <span class="built_in">delete</span>(tempToOriginal, k)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>reduceProcess</code> is just the same as <code>mapProcess</code>. Actually, from my perspective, there is nothing different.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduceProcess</span><span class="params">(reducef <span class="keyword">func</span>(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span>, id <span class="type">int</span>, nReduce <span class="type">int</span>) &#123;</span><br><span class="line">  <span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line"></span><br><span class="line">    request := ReduceTaskRequest&#123;ID: id&#125;</span><br><span class="line">    response := ReduceTaskResponse&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !ReduceRequestRPC(&amp;request, &amp;response) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response.Shutdown &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    intermediate := []KeyValue&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= response.Task.MapTaskTotal; i++ &#123;</span><br><span class="line">      inputName := fmt.Sprintf(<span class="string">&quot;mr-%d-%d&quot;</span>, i, response.Task.ID)</span><br><span class="line">      file, _ := os.Open(inputName)</span><br><span class="line">      dec := json.NewDecoder(file)</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> temp KeyValue</span><br><span class="line">        <span class="keyword">if</span> err := dec.Decode(&amp;temp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        intermediate = <span class="built_in">append</span>(intermediate, temp)</span><br><span class="line">      &#125;</span><br><span class="line">      file.Close()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sort.Sort(ByKey(intermediate))</span><br><span class="line"></span><br><span class="line">    temporaryToOriginal := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">    outputName := fmt.Sprintf(<span class="string">&quot;mr-out-%d&quot;</span>, response.Task.ID)</span><br><span class="line">    tempFile, _ := os.CreateTemp(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;tempfile-&quot;</span>)</span><br><span class="line">    temporaryToOriginal[tempFile.Name()] = outputName</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; <span class="built_in">len</span>(intermediate) &#123;</span><br><span class="line">      j := i + <span class="number">1</span></span><br><span class="line">      <span class="keyword">for</span> j &lt; <span class="built_in">len</span>(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key &#123;</span><br><span class="line">        j++</span><br><span class="line">      &#125;</span><br><span class="line">      values := []<span class="type">string</span>&#123;&#125;</span><br><span class="line">      <span class="keyword">for</span> k := i; k &lt; j; k++ &#123;</span><br><span class="line">        values = <span class="built_in">append</span>(values, intermediate[k].Value)</span><br><span class="line">      &#125;</span><br><span class="line">      output := reducef(intermediate[i].Key, values)</span><br><span class="line">      fmt.Fprintf(tempFile, <span class="string">&quot;%v %v\n&quot;</span>, intermediate[i].Key, output)</span><br><span class="line">      i = j</span><br><span class="line">    &#125;</span><br><span class="line">    tempFile.Close()</span><br><span class="line">    request.Info = temporaryToOriginal</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !ReduceFinishRPC(&amp;request, &amp;response) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    
  </div>

  
  <!-- Post Copyright -->

<div class="post-copyright">
  <p class="copyright-item">
    <span>Author: </span>
    <a href="https://luolibrary.com">shejialuo</a>
  </p>
  <p class="copyright-item">
    <span>Link: </span>
    <a href="https://luolibrary.com/2024/08/04/MIT6-824-MapReduce/">https://luolibrary.com/2024/08/04/MIT6-824-MapReduce/</a>
  </p>
  <p class="copyright-item">
    <span>License: </span>
    
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a>
  </p>
</div>

    

  

  
  <footer class="post-footer">
    
    <div class="post-tags">
      
      <a href="/tags/tag-name/">tag_name</a>
      
    </div>
    
      
  <nav class="post-nav">  
      
      
      <a class="next" href="/2024/07/28/GSoC-Week-8-9/">  
        <span class="next-text nav-default">GSoC Week 8-9</span>  
        <span class="prev-text nav-mobile">Next</span>  
        <i class="iconfont icon-right"></i>  
      </a>  
      
  </nav>  
  

  </footer>
  

</article>
        </div>
          
  <div class="comments" id="comments">  
      
      <div id="utterances-container"></div>  
      
  </div>  
  

      </div>
    </main>
    <footer id="footer" class="footer">
      <!-- Social Links -->

<div class="social-links">
  
  
  
  
  <a href="mailto:shejialuo@gmail.com" class="iconfont icon-email" title="email"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://twitter.com/luo_hope" class="iconfont icon-twitter" title="twitter"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://www.linkedin.com/in/jialuo-she-913873289/" class="iconfont icon-linkedin" title="linkedin"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://github.com/shejialuo" class="iconfont icon-github" title="github"></a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
  
</div>



<div class="copyright">

  <span class="copyright-year">
    <span>
      
      &copy;
      
      2020 - 2024      
    </span>

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>

    <span class="author">shejialuo</span>
  </span>

</div>
    </footer>
    <div class="back-to-top" id="back-to-top"> <i class="iconfont icon-up"></i> </div>
  </div>
    
    
    
    
    
  
<script>
  var container = document.getElementById('utterances-container');
  var script = document.createElement('script');
  script.src = 'https://utteranc.es/client.js';
  script.setAttribute('repo', 'shejialuo/shejialuo.github.io');
  script.setAttribute('issue-term', 'pathname');
  script.setAttribute('theme', 'github-light');
  script.setAttribute('label', 'Comment');
  script.crossorigin = 'anonymous';
  script.async = true;

  container.appendChild(script);
</script>
  
    
  

  







<script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>



<script type="text/javascript" src="/lib/slideout/slideout.js"></script>



<script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>



<!-- mermaid -->

  <script src='https://unpkg.com/mermaid@9.2.0/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


  <script type="text/javascript" src="/js/src/even.js?v=3.0.0"></script>
</body>

</html>