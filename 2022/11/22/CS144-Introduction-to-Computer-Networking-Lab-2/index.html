<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Website mata -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Disable transformation -->
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<!-- Website description -->

<meta name="description" content="CS144: Introduction to Computer Networking Lab 2" />


<!-- Website keywords -->

<meta name="keywords" content="技术, 学习, 洛的藏书阁" />




<!-- Website rss -->

<link rel="alternate" href="/atom.xml" title="洛的藏书阁" type="application/atom+xml">


<!-- Website favicon -->

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=3.0.0" />


<!-- Canonical, good for google search engine -->
<link rel="canonical" href="https://luolibrary.com/2022/11/22/CS144-Introduction-to-Computer-Networking-Lab-2/" />

<!-- Fancybox styling -->

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />


<!-- MathJax (LaTeX) support -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });  
  </script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<!-- Theme styling -->
<link rel="stylesheet" type="text/css" href="/css/style.css?v=3.0.0" />

<!-- Analytics and push -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7M238H24L4"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-7M238H24L4');
</script>

  



<!-- LeanCloud Counter -->


<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"latex":true};
</script>
  
  <title>CS144: Introduction to Computer Networking Lab 2 - 洛的藏书阁</title>

<meta name="generator" content="Hexo 7.2.0"></head>

<body>
  <div class="scrollPercentage"></div>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">洛的藏书阁</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
    <a href="/">
      <li class="mobile-menu-item">
        
        
        Home              </li>
    </a>
    
    <a href="/archives/">
      <li class="mobile-menu-item">
        
        
        Archives              </li>
    </a>
    
    <a href="/tags/">
      <li class="mobile-menu-item">
        
        
        Tags              </li>
    </a>
    
    <a href="/categories/">
      <li class="mobile-menu-item">
        
        
        Categories              </li>
    </a>
    
    <a href="/about/">
      <li class="mobile-menu-item">
        
        
        About              </li>
    </a>
    
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
      <div class="logo-wrapper">  
  <a href="/." class="logo">洛的藏书阁</a>  
</div>  
  
<nav class="site-navbar">  
    
    <ul id="menu" class="menu">  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/">  
              
              
              Home  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/archives/">  
              
              
              Archives  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/tags/">  
              
              
              Tags  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/categories/">  
              
              
              Categories  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/about/">  
              
              
              About  
              
          </a>  
        </li>  
        
    </ul>  
    
</nav>  

    </header>
    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      CS144: Introduction to Computer Networking Lab 2
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2022-11-22
      </span>
      
      
      <span class="post-category">
        
        <a href="/categories/CS144/">CS144</a>
        
      </span>
      
      
    </div>
  </header>

  
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Translating-between-64-bit-indexes-and-32-bit-seqnos"><span class="toc-number">1.</span> <span class="toc-text">Translating between 64-bit indexes and 32-bit seqnos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-receiver"><span class="toc-number">2.</span> <span class="toc-text">TCP receiver</span></a></li></ol>
    </div>
  </div>
  

  <div class="post-content">
    
    <p>You can get the whole series from <a href="https://luolibrary.com/categories/CS144/">here</a></p>
<hr>
<p>First, you should read carefully read the docs provided by the lab.</p>
<blockquote>
<p>In addition to writing to the incoming stream, the <code>TCPReceiver</code> is responsible for telling the sender two things:</p>
<ol>
<li>the index of the “first unassembled” byte which is called the “acknowledgment number”.</li>
<li>the distance between the “first unassembled” index and the “first unacceptable” index. This is called the “window size “</li>
</ol>
</blockquote>
<p>For these requirements, we have already done in the lab 0 and lab1.</p>
<h2 id="Translating-between-64-bit-indexes-and-32-bit-seqnos"><a href="#Translating-between-64-bit-indexes-and-32-bit-seqnos" class="headerlink" title="Translating between 64-bit indexes and 32-bit seqnos"></a>Translating between 64-bit indexes and 32-bit seqnos</h2><p>In <code>StreamReassembler</code>, each individual datagram has a 64-bit <em>stream index</em> and a 64-bit index is big enough that we can treat it as never overflowing. In the TCP headers, we only have a 32-bit sequence number. So the requirement is below:</p>
<ul>
<li><em>Your implementation needs to plan for 32-bit integers to wrap around</em>.</li>
<li><em>TCP sequence numbers start at a random value</em>.</li>
<li><em>The logical beginning and ending each occupy one sequence number</em></li>
</ul>
<p>The public interface is below:</p>
<ul>
<li><code>WrappingInt32 wrap(uint64_t n, WrappingInt32 isn)</code>: give an absolute sequence number and an Initial Sequence Number, produce the relative sequence number for <code>n</code>.</li>
<li><code>uint64_t unwrap(WrappingInt32 n, WrappingInt32 isn, uint64_t checkpoint)</code>: Given a sequence number, the Initial Sequence Number, and an absolute checkpoint sequence number, compute the absolute sequence number that corresponds to <code>n</code> that is closes to the checkpoint.</li>
</ul>
<p>For <code>wrap</code>, it may seem that we need to round the value. However, the addition of the two unsigned integer would automatically overflow, we could use this feature to gracefully deal with this problem.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WrappingInt32 <span class="title">wrap</span><span class="params">(<span class="type">uint64_t</span> n, WrappingInt32 isn)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Because adding unsigned integer would automatically overflow</span></span><br><span class="line">    <span class="comment">// thus we can utilize this feature to gracefully deal with this problem.</span></span><br><span class="line">    <span class="keyword">return</span> isn + <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For <code>unwrap</code>, we need to find the closest, we just use the overflow of the unsigned again.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">unwrap</span><span class="params">(WrappingInt32 n, WrappingInt32 isn, <span class="type">uint64_t</span> checkpoint)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> offset = n.<span class="built_in">raw_value</span>() - <span class="built_in">wrap</span>(checkpoint, isn).<span class="built_in">raw_value</span>();</span><br><span class="line">    <span class="type">uint64_t</span> result = checkpoint + offset;</span><br><span class="line">    <span class="keyword">if</span> (offset &gt; (<span class="number">1u</span> &lt;&lt; <span class="number">31</span>) &amp;&amp; result &gt;= (<span class="number">1ul</span> &lt;&lt; <span class="number">32</span>))</span><br><span class="line">        result -= (<span class="number">1ul</span> &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="TCP-receiver"><a href="#TCP-receiver" class="headerlink" title="TCP receiver"></a>TCP receiver</h2><p>The public interface for <code>TCPReceiver</code> class is:</p>
<ul>
<li><code>TCPReceiver(const size_t capacity)</code>: Construct a <code>TCPReceiver</code> that will store up to <code>capacity</code> bytes.</li>
<li><code>void segment_received(const TCPSegment &amp;seg)</code>: Handle an inbound TCP segment.</li>
<li><code>sdt::optional&lt;WrappingInt32&gt; ackno() const</code>: The acknowledgment number should be sent to the peer.</li>
<li><code>size_t window_size() const</code>: The window size that should be sent to the peer.</li>
<li><code>size_t unassembled_bytes() const</code>: number of bytes stored but not yet reassembled.</li>
<li><code>ByteStream &amp;stream_out()</code>: Access the reassembled byte stream.</li>
</ul>
<p>Well, we need to think what data structure we need when receiving the TCP datagram. First, we need to record the sender’s Initial Sequence Number <code>_sender_isn</code>. Because, we need this to use <code>wrap</code> to calculate the absolute acknowledge number <code>_ack</code>. We just need this two:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TCPReceiver</span> &#123;</span><br><span class="line">    <span class="comment">//! Our data structure for re-assembling bytes.</span></span><br><span class="line">    StreamReassembler _reassembler;</span><br><span class="line">    <span class="comment">//! The maximum number of bytes we&#x27;ll store.</span></span><br><span class="line">    <span class="type">size_t</span> _capacity;</span><br><span class="line">    std::optional&lt;WrappingInt32&gt; _sender_isn&#123;&#125;;  <span class="comment">//! The initial sequence number from the sender</span></span><br><span class="line">    std::optional&lt;WrappingInt32&gt; _ack&#123;&#125;;         <span class="comment">//! The acknowledge number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>From the perspective of receiver, connection is easy. We will receive two datagrams from the sender. The first datagram is important because the <code>SYN</code> bit is set to 1. So we need to handle this case.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPReceiver::segment_received</span><span class="params">(<span class="type">const</span> TCPSegment &amp;seg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Here, we should ensure we set the initial sequence number</span></span><br><span class="line">    <span class="comment">// when we first time receive the SYN.</span></span><br><span class="line">    <span class="keyword">if</span> (seg.<span class="built_in">header</span>().syn) &#123;</span><br><span class="line">        _sender_isn.<span class="built_in">emplace</span>(seg.<span class="built_in">header</span>().seqno);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When we receive the <code>syn</code>, we just set the <code>_sender_isn</code> to the <code>seg.header().seqno</code>. You may wonder why we not set the <code>_ack</code> to be the <code>_sender_sin.value() + 1</code>. The reason is that:</p>
<blockquote>
<p>Note that the SYN flag is just one flag in the header. The same segment could also carry data and could even have the FIN flag set.</p>
</blockquote>
<p>Before transferring the data, we need to understand how to get the window size, actually, it is super easy. Remember what we have done in the lab 0, yes, there is a method called <code>remaining_capacity</code> which means that the ringBuffer remain size, we use this as the window size. So you could know what we use <code>stream_out().bytes_written()</code> as the acknowledge number.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">TCPReceiver::window_size</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">stream_out</span>().<span class="built_in">remaining_capacity</span>(); &#125;</span><br><span class="line"><span class="function">optional&lt;WrappingInt32&gt; <span class="title">TCPReceiver::ackno</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _ack; &#125;</span><br></pre></td></tr></table></figure>

<p>However, this is not the reality. Here, I assume all the operation is not async. However, in kernel, things would be much more complicate.</p>
<p>So, at now it is easy for us to implement transferring the data. However, there is a corner case, the process of three-way handshake, the ACK should increment, so I use a <em>stupid</em> way to substitute the <code>_sender_isn</code> and <code>_ack</code>. (Please see the comment for more descriptive explanation).</p>
<p>And how should we close the TCP connection. We just add 1 to <code>_ack</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPReceiver::segment_received</span><span class="params">(<span class="type">const</span> TCPSegment &amp;seg)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Do the operation</span></span><br><span class="line">    <span class="comment">// Pay attention to `stream_out().bytes_written()`, this is one</span></span><br><span class="line">    <span class="comment">// of the most interesting abstraction provided by ByteStream class.</span></span><br><span class="line">    <span class="comment">// When we use `push_substring`, we would push the bytes to ByteStream.</span></span><br><span class="line">    <span class="comment">// Thus, we can get one important idea:</span></span><br><span class="line">    <span class="comment">// stream_out().bytes_written() is always pointing to the</span></span><br><span class="line">    <span class="comment">// absolute current window size start</span></span><br><span class="line">    <span class="keyword">if</span> (_sender_isn.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">        _reassembler.<span class="built_in">push_substring</span>(seg.<span class="built_in">payload</span>().<span class="built_in">copy</span>(),</span><br><span class="line">                                    <span class="built_in">unwrap</span>(seg.<span class="built_in">header</span>().seqno, _sender_isn.<span class="built_in">value</span>(), <span class="built_in">stream_out</span>().<span class="built_in">bytes_written</span>()),</span><br><span class="line">                                    seg.<span class="built_in">header</span>().fin);</span><br><span class="line">        _ack.<span class="built_in">emplace</span>(<span class="built_in">wrap</span>(<span class="built_in">stream_out</span>().<span class="built_in">bytes_written</span>(), _sender_isn.<span class="built_in">value</span>()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When we first accept the SYN, we should pay attention there is no</span></span><br><span class="line">        <span class="comment">// payload, in this situation, `_ack` would be equal to `_isn`. We should</span></span><br><span class="line">        <span class="comment">// avoid this situation.</span></span><br><span class="line">        <span class="keyword">if</span> (seg.<span class="built_in">header</span>().syn) &#123;</span><br><span class="line">            _ack.<span class="built_in">emplace</span>(_ack.<span class="built_in">value</span>() + <span class="number">1</span>);</span><br><span class="line">            _sender_isn.<span class="built_in">emplace</span>(_ack.<span class="built_in">value</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only we have initialized the connection and we have made all</span></span><br><span class="line">        <span class="comment">// the bytes written into the ByteStream. We can plus one to `_ack`.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The reason why we should plus one to `_ack` is simple. Because</span></span><br><span class="line">        <span class="comment">// when closing the TCP connection, we receive the sender&#x27;s seq</span></span><br><span class="line">        <span class="comment">// number, because of no payload, our `_ack` is equal to `seg.header().seqno`</span></span><br><span class="line">        <span class="comment">// Don&#x27;t consider the sending, if we need the second FIN from the sender,</span></span><br><span class="line">        <span class="comment">// we should plus one to the `_ack` thus receiving the second FIN.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stream_out</span>().<span class="built_in">input_ended</span>()) &#123;</span><br><span class="line">            _ack = <span class="built_in">WrappingInt32</span>(_ack.<span class="built_in">value</span>() + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    
  </div>

  
  <!-- Post Copyright -->

<div class="post-copyright">
  <p class="copyright-item">
    <span>Author: </span>
    <a href="https://luolibrary.com">shejialuo</a>
  </p>
  <p class="copyright-item">
    <span>Link: </span>
    <a href="https://luolibrary.com/2022/11/22/CS144-Introduction-to-Computer-Networking-Lab-2/">https://luolibrary.com/2022/11/22/CS144-Introduction-to-Computer-Networking-Lab-2/</a>
  </p>
  <p class="copyright-item">
    <span>License: </span>
    
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a>
  </p>
</div>

    

  

  
  <footer class="post-footer">
    
    <div class="post-tags">
      
      <a href="/tags/%E6%8A%80%E6%9C%AF/">技术</a>
      
      <a href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
      
    </div>
    
      
  <nav class="post-nav">  
      
      <a class="prev" href="/2022/11/23/CS144-Introduction-to-Computer-Networking-Lab-3/">  
        <i class="iconfont icon-left"></i>  
        <span class="prev-text nav-default">CS144: Introduction to Computer Networking Lab 3</span>  
        <span class="prev-text nav-mobile">Prev</span>  
      </a>  
      
      
      <a class="next" href="/2022/11/21/CS144-Introduction-to-Computer-Networking-Lab-1/">  
        <span class="next-text nav-default">CS144: Introduction to Computer Networking Lab 1</span>  
        <span class="prev-text nav-mobile">Next</span>  
        <i class="iconfont icon-right"></i>  
      </a>  
      
  </nav>  
  

  </footer>
  

</article>
        </div>
          
  <div class="comments" id="comments">  
      
      <div id="utterances-container"></div>  
      
  </div>  
  

      </div>
    </main>
    <footer id="footer" class="footer">
      <!-- Social Links -->

<div class="social-links">
  
  
  
  
  <a href="mailto:shejialuo@gmail.com" class="iconfont icon-email" title="email"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://twitter.com/luo_hope" class="iconfont icon-twitter" title="twitter"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://www.linkedin.com/in/jialuo-she-913873289/" class="iconfont icon-linkedin" title="linkedin"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://github.com/shejialuo" class="iconfont icon-github" title="github"></a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
  
</div>



<div class="copyright">

  <span class="copyright-year">
    <span>
      
      &copy;
      
      2020 - 2024      
    </span>

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>

    <span class="author">shejialuo</span>
  </span>

</div>
    </footer>
    <div class="back-to-top" id="back-to-top"> <i class="iconfont icon-up"></i> </div>
  </div>
    
    
    
    
    
  
<script>
  var container = document.getElementById('utterances-container');
  var script = document.createElement('script');
  script.src = 'https://utteranc.es/client.js';
  script.setAttribute('repo', 'shejialuo/shejialuo.github.io');
  script.setAttribute('issue-term', 'pathname');
  script.setAttribute('theme', 'github-light');
  script.setAttribute('label', 'Comment');
  script.crossorigin = 'anonymous';
  script.async = true;

  container.appendChild(script);
</script>
  
    
  

  







<script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>



<script type="text/javascript" src="/lib/slideout/slideout.js"></script>



<script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>



<!-- mermaid -->

  <script src='https://unpkg.com/mermaid@9.2.0/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


  <script type="text/javascript" src="/js/src/even.js?v=3.0.0"></script>
</body>

</html>