<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Website mata -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Disable transformation -->
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<!-- Website description -->

<meta name="description" content="MIT6.858-SUNDR的实现" />


<!-- Website keywords -->

<meta name="keywords" content="学习, 洛的藏书阁" />




<!-- Website rss -->

<link rel="alternate" href="/atom.xml" title="洛的藏书阁" type="application/atom+xml">


<!-- Website favicon -->

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=3.0.0" />


<!-- Canonical, good for google search engine -->
<link rel="canonical" href="https://luolibrary.com/2023/09/11/MIT6-858-SUNDR的实现/" />

<!-- Fancybox styling -->

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />


<!-- MathJax (LaTeX) support -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });  
  </script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<!-- Theme styling -->
<link rel="stylesheet" type="text/css" href="/css/style.css?v=3.0.0" />

<!-- Analytics and push -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7M238H24L4"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-7M238H24L4');
</script>

  



<!-- LeanCloud Counter -->


<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"latex":true};
</script>
  
  <title>MIT6.858-SUNDR的实现 - 洛的藏书阁</title>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div class="scrollPercentage"></div>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">洛的藏书阁</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
    <a href="/">
      <li class="mobile-menu-item">
        
        
        Home              </li>
    </a>
    
    <a href="/archives/">
      <li class="mobile-menu-item">
        
        
        Archives              </li>
    </a>
    
    <a href="/tags/">
      <li class="mobile-menu-item">
        
        
        Tags              </li>
    </a>
    
    <a href="/categories/">
      <li class="mobile-menu-item">
        
        
        Categories              </li>
    </a>
    
    <a href="/about/">
      <li class="mobile-menu-item">
        
        
        About              </li>
    </a>
    
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
      <div class="logo-wrapper">  
  <a href="/." class="logo">洛的藏书阁</a>  
</div>  
  
<nav class="site-navbar">  
    
    <ul id="menu" class="menu">  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/">  
              
              
              Home  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/archives/">  
              
              
              Archives  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/tags/">  
              
              
              Tags  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/categories/">  
              
              
              Categories  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/about/">  
              
              
              About  
              
          </a>  
        </li>  
        
    </ul>  
    
</nav>  

    </header>
    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      MIT6.858-SUNDR的实现
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2023-09-11
      </span>
      
      
      <span class="post-category">
        
        <a href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
        
      </span>
      
      
    </div>
  </header>

  
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="toc-number">1.</span> <span class="toc-text">源码阅读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.</span> <span class="toc-text">基本的类型定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">基本的存储实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Itable"><span class="toc-number">1.3.</span> <span class="toc-text">Itable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FAPI%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.4.</span> <span class="toc-text">文件系统API接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.</span> <span class="toc-text">实现创建文件和目录的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Version-Structure-List%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">Version Structure List实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%96%B9%E9%9D%A2%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.3.</span> <span class="toc-text">安全方面实现</span></a></li></ol></li></ol>
    </div>
  </div>
  

  <div class="post-content">
    
    <p>MIT6.858最后一个实验是复现论文<a target="_blank" rel="noopener" href="https://www.usenix.org/legacy/event/osdi04/tech/full_papers/li_j/li_j.pdf">Secure Untrusted Data Repository</a>的串行化实现。在开始做这个实验之前，你应该仔细地阅读这篇论文。</p>
<h2 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h2><p>MIT6.858提供了基本的文件系统代码，了解这个文件系统是如何构建的，对于代码实现的相当重要。</p>
<h3 id="基本的类型定义"><a href="#基本的类型定义" class="headerlink" title="基本的类型定义"></a>基本的类型定义</h3><p>在SUNDR中，有用户和群组的划分。同时每一个文件都是由<code>&lt;principal, i-number&gt;</code>对应的。显然，每个用户和群组都可以有多个文件，所以只需要再定义一个类包含用户（群组）和所有的文件个数。故源代码中定义了三个类型：</p>
<ul>
<li><code>User</code>：继承于<code>Principal</code>。</li>
<li><code>Group</code>：继承于<code>Principal</code>。</li>
<li><code>I</code>：包含<code>Principal</code>和<code>n</code>。</li>
</ul>
<h3 id="基本的存储实现"><a href="#基本的存储实现" class="headerlink" title="基本的存储实现"></a>基本的存储实现</h3><p>在文件系统中，最基本的存储单元是<code>Block</code>类，其可以存储数据、inode等信息。由于SUNDR基于快照的机制保障安全，故其与git的实现机制相似，基于content-hash机制对每一个Block进行哈希。故<code>Block</code>类提供了两个函数：</p>
<ul>
<li><code>store(blob)</code>：<code>blob</code>是存储的数据，其为二进制数据。其返回值为二进制内容的sha1sum。</li>
<li><code>load(chash)</code>：根据哈希值找到相应的block，进而读取block中的二进制数据。</li>
</ul>
<p>同时，文件系统定义了<code>Inode</code>类，用于作为元数据。其包含了某一个文件或者目录的基本信息，例如类型，创建的时间，修改的时间及其对应的所有的block的哈希值。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Inode</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.size = <span class="number">0</span></span><br><span class="line">        self.kind = <span class="number">0</span> <span class="comment"># 0 is dir, 1 is file</span></span><br><span class="line">        self.ex = <span class="literal">False</span></span><br><span class="line">        self.ctime = <span class="number">0</span></span><br><span class="line">        self.mtime = <span class="number">0</span></span><br><span class="line">        self.blocks = []</span><br></pre></td></tr></table></figure>

<p>显然，<code>Inode</code>类也是存储在block中的，所以我们需要基于<code>ihash</code>通过调用<code>block.load(chash)</code>函数得到其二进制数据，然后进行反序列化得到其字段值。当我们想要获得文件的值时，我们直接使用如下的函数即可：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join([secfs.store.block.load(b) <span class="keyword">for</span> b <span class="keyword">in</span> self.blocks])</span><br></pre></td></tr></table></figure>

<p>然而，我们必须考虑目录这种情况。在SUNDR中，目录的每一项元素都是一个元组<code>(filename, I)</code>。其中其定义了<code>add</code>函数来实现在一个目录里面添加一个新项。同时定义了<code>find_under</code>函数用来查找目录。</p>
<h3 id="Itable"><a href="#Itable" class="headerlink" title="Itable"></a>Itable</h3><p>每个用户和群组都拥有一个<code>i-table</code>。对于用户而言，<code>i-table</code>保存的是<code>i-number</code>到<code>ihash</code>的映射。对于群组而言，<code>i-table</code>保存的是<code>i-number</code>到<code>I</code>的映射。因此对于<code>Itable</code>类而言，源码利用了python的动态性，直接定义了一个dict。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Itable</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.mapping = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">ihandle</span>):</span><br><span class="line">        b = secfs.store.block.load(ihandle)</span><br><span class="line">        <span class="keyword">if</span> b == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        t = Itable()</span><br><span class="line">        t.mapping = pickle.loads(b)</span><br><span class="line">        <span class="keyword">return</span> t</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bytes</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(self.mapping)</span><br></pre></td></tr></table></figure>

<p>然后，其定义了一个关键的函数<code>resolve</code>，基于<code>i-table</code>解析得到<code>ihash</code>或者<code>I</code>。同时，该函数支持递归地解析<code>I</code>最终得到<code>ihash</code>。其思路实现比较简单。</p>
<p>最关键的在于<code>modmap(mod_as, i, ihash)</code>函数，对于某个用户<code>mod_as</code>而言，给定一个<code>I</code>类，需要修改或者创建其在<code>i-table</code>中的映射。然而关键在于<code>I</code>有两类情况，一种是用户，另一种是群组。</p>
<ul>
<li>对于用户而言，其<code>mod_as</code>和<code>i.p</code>必须相等。我们需要修改或者创建其在<code>i-table</code>中的映射，这个过程相当简单。</li>
<li>对于群组而言，情况就会比较复杂了。我们首先需要基于提供的<code>i</code>找到其对应的<code>I</code>，也就是调用<code>resolve</code>函数并进行一层的解析。如果<code>I.p = mod_as</code>，证明群组的修改和用户的修改是一致的，我们一定会最先对用户的修改进行处理，所以此处不需要进行任何操作。如果不是那么证明我们需要创建一个新的<code>I</code>，于是调用<code>modmap(mod_as, I(mod_as), ihash)</code>在<code>mod_as</code>用户的<code>i-table</code>中添加映射。</li>
</ul>
<h3 id="文件系统API接口"><a href="#文件系统API接口" class="headerlink" title="文件系统API接口"></a>文件系统API接口</h3><p>源码已经给出了某些文件系统接口的实现，例如<code>link</code>函数，<code>link</code>函数的作用即将一个<code>I</code>添加到当前目录中，其原理很简单，首先需要基于当前目录构建一个<code>Directory</code>。然后调用<code>add</code>函数添加目录，并使用<code>modmap</code>修改映射关系。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Omit syntax check and write check</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">link</span>(<span class="params"><span class="keyword">def</span> link(<span class="params">link_as: User, i: I, parent_i: I, name: <span class="built_in">str</span></span>):</span></span><br><span class="line"><span class="params">    parent_ihash = secfs.store.tree.add(<span class="params">parent_i, name, i</span>)</span></span><br><span class="line"><span class="params">    secfs.tables.modmap(<span class="params">link_as, parent_i, parent_ihash</span>)</span>)</span><br></pre></td></tr></table></figure>

<p>在SUNDR论文中，文件系统的初始化是root用户生成一对私钥&#x2F;公钥，同时创建<code>.users</code>和<code>.groups</code>文件，存储相应的公钥及印映射信息。文件系统使用<code>init</code>函数提供了接口。其首先需要创建一个类型为目录的inode，然后添加<code>.</code>和<code>..</code>目录。同时需要创建<code>.users</code>和<code>.groups</code>文件，调用<code>link</code>函数添加到根目录中。</p>
<p>在了解了基本的数据结构以及映射关系后，我们就可以开始编写自己的代码。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="实现创建文件和目录的功能"><a href="#实现创建文件和目录的功能" class="headerlink" title="实现创建文件和目录的功能"></a>实现创建文件和目录的功能</h3><p>我们需要所做的第一个工作就是实现创建文件和目录。无论是文件还是目录我们都需要首先创建一个<code>Inode</code>。然后我们需要将其存储在文件系统中，并得到其hash值<code>ihash</code>。然后我们需要调用<code>modmap</code>修改itable的映射关系。对于目录而言，我们需要做更多额外的工作。我们需要添加在当前目录创建<code>.</code>和<code>..</code>，并调用<code>modmap</code>修改itable的映射关系。然后我们调用<code>link</code>维护目录结构关系。</p>
<p>然而，我们需要考虑如果是为一个群组创建文件和目录呢？实际上面的流程都是一样的，因为对于群组来说，<code>itable</code>是存储的映射，所以我们仅仅只需要更新这个映射关系即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_create</span>(<span class="params">parent_i: I, name: <span class="built_in">str</span>, create_as: User, create_for: Principal, isdir: <span class="built_in">bool</span></span>):</span><br><span class="line">    ...</span><br><span class="line">    ihash = secfs.store.block.store(node.<span class="built_in">bytes</span>())</span><br><span class="line">    store_i = secfs.tables.modmap(create_as, I(create_for), ihash)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isdir:</span><br><span class="line">        new_ihash = secfs.store.tree.add(store_i, <span class="string">b&#x27;.&#x27;</span>, store_i)</span><br><span class="line">        secfs.tables.modmap(create_as, store_i, new_ihash)</span><br><span class="line">        new_ihash = secfs.store.tree.add(store_i, <span class="string">b&#x27;..&#x27;</span>, parent_i)</span><br><span class="line">        secfs.tables.modmap(create_as, store_i, new_ihash)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> create_for.is_group():</span><br><span class="line">        secfs.tables.modmap(create_as, I(create_for), store_i)</span><br><span class="line"></span><br><span class="line">    link(create_as, store_i, parent_i, name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> store_i</span><br></pre></td></tr></table></figure>

<h3 id="Version-Structure-List实现"><a href="#Version-Structure-List实现" class="headerlink" title="Version Structure List实现"></a>Version Structure List实现</h3><p>目前所有的映射关系都是存储在<code>current_table</code>中的，其是存储在内存中的，当有其他客户端时，其访问服务端，得不到<code>current_table</code>的信息，所以需要对<code>current_table</code>进行修改，其需要存储在文件系统中。在这个过程中，我们不考虑任何安全方面的实现。</p>
<p>我们首先需要认识到<code>current_table</code>保存的是<code>Principal</code>到<code>Itable</code>的映射。由于函数<code>resolve</code>以及<code>modmap</code>严重依赖于<code>current_table</code>，所以应该尽可能合理地设计数据结构，减少代码的更改。</p>
<p>在SUNDR原论文中，其提供的数据结构<code>VersionStructure</code>包含每一个用户的<code>i-handle</code>，所属的群组的<code>g-handle</code>以及<code>version_vector</code>。这是与当前的逻辑矛盾的，当前的映射单独保存了用户和群组的，为了简便起见，我没有采取这样的数据结构。我仍然按照当前的逻辑进行实现。因此，我定义了如下的数据结构。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VersionStructure</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    `VersionStructure` is the most important data structure in this lab. In</span></span><br><span class="line"><span class="string">    the original SUNDR paper, the version structure is specified only for</span></span><br><span class="line"><span class="string">    the `User`. Each user could have one and more group handles. However,</span></span><br><span class="line"><span class="string">    it&#x27;s a bad idea for the current code. Because the `current_itables`</span></span><br><span class="line"><span class="string">    mapping the `I` to the inode. The `I.p` could be user or the group.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    version_vector : <span class="built_in">dict</span>[Principal, <span class="built_in">int</span>]</span><br><span class="line">    <span class="comment"># It could be the user or the group, it is only the hash, should</span></span><br><span class="line">    <span class="comment"># later read from</span></span><br><span class="line">    i_handle: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.version_vector = &#123;&#125;</span><br><span class="line">        self.i_handle = <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>根据SUNDR论文，每次每个客户端对文件系统进行操作之间，都需要从服务器下载最新的VSL，当进行了修改需要对VSL进行验证，如果验证通过，则进行数字签名，上传VSL。从性能的角度来说，传递单独的<code>VersionStructure</code>是节省带宽的，然而我认为此处不是这个lab的核心，因此我才用了最粗暴的方式，即上传整个VSL。故定义了如下的数据结构：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VersionStructureList</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    `VersionStructureList` is the core data structure here, It</span></span><br><span class="line"><span class="string">    contains the the user or the group `VersionStructure`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    version_structures: <span class="built_in">dict</span>[Principal, VersionStructure]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.version_structures = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Download the `version_structure_list` from the server, it should</span></span><br><span class="line"><span class="string">        be called every time it operates on the file system. It&#x27;s may</span></span><br><span class="line"><span class="string">        be a bad idea, but it is simple.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> server</span><br><span class="line">        blob = server.read_version_structure_list()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> blob == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;data&quot;</span> <span class="keyword">in</span> blob:</span><br><span class="line">            <span class="keyword">import</span> base64</span><br><span class="line">            blob = base64.b64decode(blob[<span class="string">&quot;data&quot;</span>])</span><br><span class="line"></span><br><span class="line">        self.version_structures = pickle.loads(blob)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> server</span><br><span class="line">        blob = pickle.dumps(self.version_structures)</span><br><span class="line">        server.store_version_structure_list(blob)</span><br></pre></td></tr></table></figure>

<p>我们要在server端添加<code>store_version_structure_list</code>RPC调用，以及<code>read_version_structure_list</code>RPC调用。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SecFSRPC</span>():</span><br><span class="line">    ...</span><br><span class="line"><span class="meta">    @Pyro4.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_version_structure_list</span>(<span class="params">self</span>):</span><br><span class="line">        chash = self.version_structure_list_hash</span><br><span class="line">        <span class="keyword">if</span> chash != <span class="literal">None</span> <span class="keyword">and</span> chash <span class="keyword">in</span> self.blocks:</span><br><span class="line">            <span class="keyword">return</span> self.blocks[chash]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @Pyro4.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">store_version_structure_list</span>(<span class="params">self, blob</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;data&quot;</span> <span class="keyword">in</span> blob:</span><br><span class="line">            <span class="keyword">import</span> base64</span><br><span class="line">            blob = base64.b64decode(blob[<span class="string">&quot;data&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> hashlib</span><br><span class="line">        chash = hashlib.sha224(blob).hexdigest()</span><br><span class="line">        self.blocks[chash] = blob</span><br><span class="line">        self.version_structure_list_hash = chash</span><br></pre></td></tr></table></figure>

<p>现在到达了最关键的一步，也就是我们需要修改<code>resolve</code>和<code>modmap</code>中的代码，我们需要替换掉<code>current_table</code>。我们需要一点即可，即<code>VersionStructure</code>存储的是<code>i-handle</code>我们必须进行磁盘的读写，而不是类似源码中直接存储<code>Itable</code>（实际上这一步是可以优化的，如果其<code>i-handle</code>没有发生变化，我们可以实现缓存，而不是从磁盘中实现读写，然而我忽略了因为这并不是这个lab的核心）。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">resolve</span>(<span class="params">i: I, resolve_groups = <span class="literal">True</span></span>):</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">global</span> version_structure_list</span><br><span class="line">    <span class="keyword">if</span> principal <span class="keyword">not</span> <span class="keyword">in</span> version_structure_list.version_structures:</span><br><span class="line">        <span class="comment"># User does not yet have an itable</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    i_handle = version_structure_list.version_structures[principal].i_handle</span><br><span class="line">    t = Itable.load(i_handle)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">modmap</span>(<span class="params">mod_as: User, i: I, ihash</span>) -&gt; I:</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># find (or create) the principal&#x27;s itable</span></span><br><span class="line">    t = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">global</span> version_structure_list</span><br><span class="line">    <span class="keyword">if</span> i.p <span class="keyword">not</span> <span class="keyword">in</span> version_structure_list.version_structures:</span><br><span class="line">        <span class="keyword">if</span> i.allocated():</span><br><span class="line">            <span class="comment"># this was unexpected;</span></span><br><span class="line">            <span class="comment"># user did not have an itable, but an inumber was given</span></span><br><span class="line">            <span class="keyword">raise</span> ReferenceError(<span class="string">&quot;itable not available&quot;</span>)</span><br><span class="line">        t = Itable()</span><br><span class="line">        version_structure_list.version_structures[i.p] = VersionStructure()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;no current list for principal&quot;</span>, i.p, <span class="string">&quot;; creating empty table&quot;</span>, t.mapping)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        i_handle = version_structure_list.version_structures[i.p].i_handle</span><br><span class="line">        t = Itable.load(i_handle)</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    i_handle = secfs.store.block.store(t.<span class="built_in">bytes</span>())</span><br><span class="line">    version_structure_list.version_structures[i.p].i_handle = i_handle</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i</span><br></pre></td></tr></table></figure>

<p>到了此处，我们就可以通过百分之87的测试。可见，我们已经完成了大部分的工作。剩下的就是实现安全方面的功能，这个lab最难的并不在于代码，而是你如何进行数据结构的设计。</p>
<h3 id="安全方面实现"><a href="#安全方面实现" class="headerlink" title="安全方面实现"></a>安全方面实现</h3><p>要实现安全方面就很简单了，需要考虑如下两个（由于时间关系，此处我并没有进行验证）：</p>
<ol>
<li>验证服务器端的身份</li>
<li>实现SUNDR协议</li>
</ol>

    
  </div>

  
  <!-- Post Copyright -->

<div class="post-copyright">
  <p class="copyright-item">
    <span>Author: </span>
    <a href="https://luolibrary.com">shejialuo</a>
  </p>
  <p class="copyright-item">
    <span>Link: </span>
    <a href="https://luolibrary.com/2023/09/11/MIT6-858-SUNDR%E7%9A%84%E5%AE%9E%E7%8E%B0/">https://luolibrary.com/2023/09/11/MIT6-858-SUNDR%E7%9A%84%E5%AE%9E%E7%8E%B0/</a>
  </p>
  <p class="copyright-item">
    <span>License: </span>
    
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a>
  </p>
</div>

    

  

  
  <footer class="post-footer">
    
    <div class="post-tags">
      
      <a href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a>
      
    </div>
    
      
  <nav class="post-nav">  
      
      <a class="prev" href="/2023/09/19/TopKProblem%E5%AE%9E%E6%88%98/">  
        <i class="iconfont icon-left"></i>  
        <span class="prev-text nav-default">TopKProblem实战</span>  
        <span class="prev-text nav-mobile">Prev</span>  
      </a>  
      
      
      <a class="next" href="/2023/08/27/CS149-Extra-Assignment-Implement-Dense-Matrix-Matrix-Multiplication/">  
        <span class="next-text nav-default">CS149-Extra-Assignment-Implement Dense Matrix-Matrix Multiplication</span>  
        <span class="prev-text nav-mobile">Next</span>  
        <i class="iconfont icon-right"></i>  
      </a>  
      
  </nav>  
  

  </footer>
  

</article>
        </div>
          
  <div class="comments" id="comments">  
      
      <div id="utterances-container"></div>  
      
  </div>  
  

      </div>
    </main>
    <footer id="footer" class="footer">
      <!-- Social Links -->

<div class="social-links">
  
  
  
  
  <a href="mailto:shejialuo@gmail.com" class="iconfont icon-email" title="email"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://twitter.com/luo_hope" class="iconfont icon-twitter" title="twitter"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://www.linkedin.com/in/jialuo-she-913873289/" class="iconfont icon-linkedin" title="linkedin"></a>
  
  
  
  
  
  
  
  
  
  <a target="_blank" rel="noopener" href="https://github.com/shejialuo" class="iconfont icon-github" title="github"></a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
  
</div>



<div class="copyright">

  <span class="copyright-year">
    <span>
      
      &copy;
      
      2020 - 2024      
    </span>

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>

    <span class="author">shejialuo</span>
  </span>

</div>
    </footer>
    <div class="back-to-top" id="back-to-top"> <i class="iconfont icon-up"></i> </div>
  </div>
    
    
    
    
    
  
<script>
  var container = document.getElementById('utterances-container');
  var script = document.createElement('script');
  script.src = 'https://utteranc.es/client.js';
  script.setAttribute('repo', 'shejialuo/shejialuo.github.io');
  script.setAttribute('issue-term', 'pathname');
  script.setAttribute('theme', 'github-light');
  script.setAttribute('label', 'Comment');
  script.crossorigin = 'anonymous';
  script.async = true;

  container.appendChild(script);
</script>
  
    
  

  







<script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>



<script type="text/javascript" src="/lib/slideout/slideout.js"></script>



<script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>



<!-- mermaid -->

  <script src='https://unpkg.com/mermaid@9.2.0/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>


  <script type="text/javascript" src="/js/src/even.js?v=3.0.0"></script>
</body>

</html>